<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
      crossorigin="anonymous"
    />

    <!-- fontAwesome cdn -->
    <script
      src="https://kit.fontawesome.com/8efedf8b16.js"
      crossorigin="anonymous"
    ></script>

    <title>Reset Password</title>

    <link rel="stylesheet" href="./assets/css/forgot-password.css" />
    <style>
      .auth-content-box {
        padding: 30px;
        margin-top: 5% !important;
        width: 480px;
        background: #fff;
        box-shadow: 0 6px 16px 0 rgba(0, 0, 0, 0.2);
      }

      .icon {
        cursor: pointer;
        font-size: 1.25rem;
      }

      .valid-feedback,
      .invalid-feedback {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Navbar section starts -->

    <section>
      <div class="container-nav bg-dark">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <a class="navbar-brand" href="#"
            >Weaver<span class="m-brand">M</span>inds</a
          >
          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                <a class="nav-link px-4" href="./login.html"
                  >Login <span class="sr-only">(current)</span></a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link px-4" href="./register.html">Register</a>
              </li>
              <li class="nav-item">
                <a class="nav-link px-4" href="./candidate.html">Candidates</a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </section>
    <!-- navbar section ends -->

    <!-- forgot password template starts-->
    <section class="forgot-pass-container" id="forgot-password-template">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-6">
            <div class="mr-auto p-lg-5">
              <img
                src="./undraw/undraw_secure_login_pdn4.svg"
                class="img-fluid"
                alt="Reset Password"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="auth-content-box mx-auto">
              <div class="text-center">
                <p class="auth-content-title">Reset Password</p>

                <!-- <p class="form-text text-muted">
                  Your password must be 8 to 20 character long , and must
                  contain lowercase letter, uppercase letter, number, and
                  special characters
                </p> -->

                <div id="alert-area"></div>

                <div class="text-left my-2">
                  <label for="password">Password</label>
                  <input
                    type="password"
                    id="password"
                    class="form-control d-inline"
                    placeholder="Enter Password"
                    aria-describedby="passwordHelpBlock"
                  />
                  <div id="password-feedback"></div>
                </div>

                <div class="text-left my-2">
                  <label for="confirm-password">Confirm Password</label>
                  <input
                    type="password"
                    id="confirm-password"
                    class="form-control d-inline"
                    placeholder="Confirm password"
                    aria-describedby="confirm passwordHelpBlock"
                  />
                  <div id="confirm-password-feedback"></div>
                </div>

                <br />

                <div>
                  <!-- ordinary btn -->
                  <button class="btn btn-success text-light" id="submit-btn">
                    Submit
                  </button>

                  <!-- spinner btn -->
                  <button
                    class="btn btn-success"
                    id="spinner-btn"
                    type="button"
                    disabled
                  >
                    <span
                      class="spinner-border spinner-border-sm"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Loading...
                  </button>

                  <!-- info tooltip -->
                  <span
                    class="d-inline-block"
                    tabindex="0"
                    data-toggle="tooltip"
                    title="Your password must be 8 to 20 character long , and must
                  contain lowercase letter, uppercase letter, number, and
                  special characters"
                  >
                    <i class="fas fa-info-circle icon text-dark"></i>
                  </span>
                </div>

                <div class="my-2">
                  <p>Back to <a href="./login.html">Login</a></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- forgot password templateends-->

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
      crossorigin="anonymous"
    ></script>

    <script>
      const backendIP = "http://localhost:8090";

      const parsedUrl = new URL(window.location.href);
      // let email = parsedUrl.searchParams.get("email").trim();
      let email = " blahblah@gmail.com ";

      console.log(email);

      // ---------------------------------- ALERT AREA ------------------------------------------------------

      const showAlert = (msg, type = "warning") => {
        $("#alert-area").empty();
        let html = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <strong>${msg}</strong>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>`;

        $("#alert-area").append(html);
      };

      const cleartAlert = () => {
        $("#alert-area").empty();
      };
      // ---------------------------PASSWORD VALIDATION ----------------------------------------------------------------------------
      // Here input argument is an password element reference
      function checkPassword(input) {
        var decimal =
          /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[^a-zA-Z0-9])(?!.*\s).{8,20}$/;

        if (input.match(decimal)) {
          console.log("Password Validation Successful!");

          return true;
        } else {
          console.log("Password Validation UnSuccessful!");

          return false;
        }
      }

      // -----------------    FIELD EMPTY OR NOT ------------------------------------------------
      const isValueEmptyOrNot = (item) => {
        // console.log(item);
        let value = item.val().trim();
        if (value == "" || !value) {
          // console.log("true");
          return true;
        } else {
          // console.log("false");
          return false;
        }
      };

      // --------------------------   PASSWORD MATCH VALIDATION -----------------------------------
      const checkPasswordMatch = () => {
        // if (!$("#confirm-password").val() || !$("#confirm-password").val()) {
        //   passwordValidationFailure("Please enter password!");
        //   confirmPasswordValidationFailure("Please enter confirm password!");
        //   return false;
        // }

        if (isValueEmptyOrNot($("#password"))) {
          passwordValidationFailure("Please enter password!");
          return false;
        }

        if (isValueEmptyOrNot($("#confirm-password"))) {
          confirmPasswordValidationFailure("Please enter confirm password!");
          return false;
        }

        if ($("#confirm-password").val() == $("#password").val()) {
          passwordValidationSuccess();
          confirmPasswordValidationSuccess();
          return true;
        } else {
          confirmPasswordValidationFailure("Passwords don't match");
          return false;
        }
      };

      // ---------------- SUBMIT ON CLICK LOGIC -------------------------------------------------------
      $("#submit-btn").click(() => {
        passwordFieldValidator();

        confirmPasswordFieldValidator();

        if (checkPasswordMatch()) {
          $("#spinner-btn").show();
          $("#submit-btn").hide();

          let password = $("#password").val().trim();

          let data = {
            email,
            password,
          };
          resetPassword(data)
            .then((res) => {
              console.log(res);
              if (res.successful) {
                setTimeout(() => {
                  showAlert(res.message, "success");
                  $("#spinner-btn").hide();
                  $("#submit-btn").show();
                }, 2000);
              } else {
                setTimeout(() => {
                  showAlert(res.message, "success");
                  $("#spinner-btn").hide();
                  $("#submit-btn").show();
                }, 2000);
              }
            })
            .catch((err) => console.log(err));
        }
      });

      // -----------  PASSWORD FIELD ON KEY DOWN LOGIC  ----------------------------------------------------
      $("#password").on("keyup", () => {
        passwordFieldValidator();
      });

      const passwordFieldValidator = () => {
        if (isValueEmptyOrNot($("#password"))) {
          passwordValidationFailure("Please enter password!");
          return false;
        }

        if (checkPassword($("#password").val())) {
          passwordValidationSuccess();
        } else {
          passwordValidationFailure();
        }
      };

      const passwordValidationSuccess = (msg = "Looks Good!") => {
        $("#password").removeClass("is-invalid");
        $("#password").addClass("is-valid");

        // adding posiitive feeback
        $("#password-feedback").empty();
        let html = `<p class="valid-feedback">${msg}</p>`;
        $("#password-feedback").append(html);
      };

      const passwordValidationFailure = (msg = "Invalid Password!") => {
        $("#password").addClass("is-invalid");
        $("#password").removeClass("is-valid");

        // adding negative feeback
        $("#password-feedback").empty();
        let html = `<p class="invalid-feedback">${msg}</p>`;
        $("#password-feedback").html(html);

        return null;
      };

      // -----------  CONFIRM PASSWORD FIELD ON KEY DOWN LOGIC  ----------------------------------------------------
      $("#confirm-password").on("keyup", () => {
        if (confirmPasswordFieldValidator()) checkPasswordMatch();
      });

      const confirmPasswordFieldValidator = () => {
        if (isValueEmptyOrNot($("#confirm-password"))) {
          confirmPasswordValidationFailure("Please enter confirm password!");
          return false;
        }

        if (checkPassword($("#confirm-password").val())) {
          confirmPasswordValidationSuccess();
          return true;
        } else {
          confirmPasswordValidationFailure();
          return false;
        }
      };

      const confirmPasswordValidationSuccess = (msg = "Looks Good!") => {
        $("#confirm-password").removeClass("is-invalid");
        $("#confirm-password").addClass("is-valid");

        // adding posiitive feeback
        $("#confirm-password-feedback").empty();
        let html = `<p class="valid-feedback">${msg}</p>`;
        $("#confirm-password-feedback").append(html);
      };

      const confirmPasswordValidationFailure = (msg = "Invalid Password!") => {
        $("#confirm-password").addClass("is-invalid");
        $("#confirm-password").removeClass("is-valid");

        // adding negative feeback
        $("#confirm-password-feedback").empty();
        let html = `<p class="invalid-feedback">${msg}</p>`;
        $("#confirm-password-feedback").html(html);
        return null;
      };

      // -------------------------- RESET PASSWORD TO SERVER --------------------------------------------
      const resetPassword = (data) => {
        console.log(data);
        return new Promise((resolve, reject) => {
          $.ajax({
            url: `${backendIP}/api/auth/reset-password`,
            type: "POST",
            dataType: "text",
            contentType: "application/JSON",
            data: JSON.stringify(data),
            success: function (result) {
              result = JSON.parse(result);

              resolve(result);
            },
            error: function (data) {
              reject(data);
            },
          });
        });
      };
    </script>
  </body>
</html>
